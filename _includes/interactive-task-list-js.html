<script>
  function enableTaskListIcons() {
    // Toggle a single icon
    function toggleIcon(icon, check) {
      if (check) {
        icon.classList.remove("fa-circle", "far");
        icon.classList.add("fa-check-circle", "fas", "checked");
      } else {
        icon.classList.remove("fa-check-circle", "fas", "checked");
        icon.classList.add("fa-circle", "far");
      }
    }

    // Get immediate child icons only
    function getImmediateChildIcons(parentLi) {
      const childLis = Array.from(parentLi.children).filter(
        (li) => li.tagName === "UL" || li.tagName === "LI"
      ); // get UL or LI
      let icons = [];
      childLis.forEach((el) => {
        if (el.tagName === "UL") {
          icons.push(
            ...Array.from(el.children)
              .filter((li) => li.classList.contains("task-list-item"))
              .map((li) => li.querySelector("i"))
              .filter(Boolean)
          );
        }
      });
      return icons;
    }

    // Check if all immediate children are checked
    function allChildrenChecked(parentLi) {
      const children = getImmediateChildIcons(parentLi);
      if (!children.length) return false;
      return children.every((icon) =>
        icon.classList.contains("fa-check-circle")
      );
    }

    // Update parent recursively
    function updateParent(parentItem) {
      const parentIcon = parentItem.querySelector("i");
      if (!parentIcon) return;
      toggleIcon(parentIcon, allChildrenChecked(parentItem));

      const grandParent = parentItem.parentElement.closest(".task-list-item");
      if (grandParent) updateParent(grandParent);
    }

    document.querySelectorAll(".task-list-item").forEach((item) => {
      const icon = item.querySelector("i");
      if (!icon) return;

      icon.style.cursor = "pointer";

      icon.onclick = (e) => {
        e.stopPropagation();

        const childIcons = getImmediateChildIcons(item);
        const isParent = childIcons.length > 0;

        // Toggle clicked icon first
        const newState = !icon.classList.contains("fa-check-circle");
        toggleIcon(icon, newState);

        // If clicked icon is parent, toggle all immediate children
        if (isParent) {
          childIcons.forEach((childIcon) => toggleIcon(childIcon, newState));
        }

        // Update parent recursively
        const parentItem = item.parentElement.closest(".task-list-item");
        if (parentItem) updateParent(parentItem);
      };
    });
  }

  document.addEventListener("DOMContentLoaded", enableTaskListIcons);
  document.addEventListener("pjax:complete", enableTaskListIcons);
</script>
